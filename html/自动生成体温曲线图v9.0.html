<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“æ¸©æ›²çº¿ç”Ÿæˆå™¨v9.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .info-box p {
            color: #666;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 13px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f0f4ff;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #e8ecff;
        }
        
        .btn-success {
            background: #51cf66;
            color: white;
        }
        
        .btn-success:hover {
            background: #40c057;
        }
        
        .btn-warning {
            background: #ffa94d;
            color: white;
        }
        
        .btn-warning:hover {
            background: #ff922b;
        }
        
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff5252;
        }
        
        .btn-info {
            background: #4ecdc4;
            color: white;
        }
        
        .btn-info:hover {
            background: #3db8af;
        }
        
        .btn-sm {
            padding: 4px 10px;
            font-size: 11px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            color: #999;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f9f9f9;
            color: #333;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f0f4ff;
        }
        
        .table-scroll {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 450px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }
        
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 2px solid #667eea;
        }
        
        .tooltip-time {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .tooltip-temp {
            margin: 4px 0;
        }
        
        .tooltip-med {
            color: #ffd700;
            margin-top: 6px;
            font-style: italic;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }
        
        .alert-success {
            background: #d3f9d8;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .medication-tag {
            display: inline-block;
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 4px;
        }
        
        .temp-normal {
            color: #51cf66;
        }
        
        .temp-elevated {
            color: #ff922b;
        }
        
        .temp-fever {
            color: #ff6b6b;
        }
        
        .preview-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        
        .preview-item:last-child {
            border-bottom: none;
        }
        
        .preview-status {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-ok {
            background: #d3f9d8;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .sort-indicator {
            display: inline-block;
            background: #e7f5ff;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .patient-list {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            max-height: 180px;
            overflow-y: auto;
        }
        
        .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            background: white;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .patient-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .patient-name {
            font-weight: bold;
            color: #333;
            flex: 1;
        }
        
        .patient-info {
            font-size: 11px;
            color: #999;
            flex: 1;
            text-align: center;
        }
        
        .patient-actions {
            display: flex;
            gap: 5px;
        }
        
        .current-patient {
            background: linear-gradient(135deg, #e7f5ff 0%, #d1ecf1 100%);
            border-left: 4px solid #667eea;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        
        .current-patient-name {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .current-patient-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .current-patient-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        
        .chart-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .modal-content .form-group {
            margin-bottom: 15px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-actions button {
            flex: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
            
            .header {
                padding: 20px;
            }
            
            .content {
                padding: 15px;
                gap: 15px;
            }
            
            button {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .chart-wrapper {
                height: 350px;
            }
            
            .patient-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .patient-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .action-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¡ï¸ ä½“æ¸©æ›²çº¿ç”Ÿæˆå™¨</h1>
            <p>ç¦»çº¿è®°å½•ä½“æ¸©å¹¶ç»˜åˆ¶æ›²çº¿ | æ”¯æŒå¤šæ‚£è€…ç®¡ç†ã€æ™ºèƒ½æ‰¹é‡å¯¼å…¥ã€å¯¼å‡ºã€æ‰“å°</p>
        </div>
        
        <div class="content">
            <!-- å·¦ä¾§è¾“å…¥åŒº -->
            <div style="overflow-y: auto; max-height: calc(100vh - 250px);">
                <div class="section-title">ğŸ‘¥ æ‚£è€…ç®¡ç†</div>
                
                <div class="current-patient" id="currentPatientDisplay" style="display: none;">
                    <div class="current-patient-name" id="currentPatientName"></div>
                    <div class="current-patient-info" id="currentPatientInfo"></div>
                    <div class="current-patient-actions">
                        <button class="btn-sm btn-info" onclick="editCurrentPatient()">âœï¸ ç¼–è¾‘ä¿¡æ¯</button>
                        <button class="btn-sm btn-danger" onclick="deleteCurrentPatient()">ğŸ—‘ï¸ åˆ é™¤æ‚£è€…</button>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>ğŸ†• æ–°å»ºæ‚£è€…</h3>
                    <p>è¾“å…¥æ‚£è€…ä¿¡æ¯å¹¶ä¿å­˜</p>
                </div>
                
                <div class="form-group">
                    <label>æ‚£è€…å§“å *</label>
                    <input type="text" id="patientName" placeholder="è¯·è¾“å…¥æ‚£è€…å§“å" autocomplete="off">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>å¹´é¾„</label>
                        <input type="number" id="patientAge" placeholder="å²" min="0" max="120">
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ«</label>
                        <select id="patientGender">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn-primary" onclick="createNewPatient()">ğŸ’¾ ä¿å­˜æ–°æ‚£è€…</button>
                    <button class="btn-warning" onclick="clearCurrentPatient()">â†º æ¸…ç©ºè¡¨å•</button>
                </div>
                
                <hr style="margin: 25px 0; border: none; border-top: 2px solid #eee;">
                
                <div class="section-title">ğŸ“‹ æ‚£è€…åˆ—è¡¨</div>
                <div class="info-box">
                    <h3>å·²ä¿å­˜çš„æ‚£è€…</h3>
                    <p>ç‚¹å‡»"åŠ è½½"æŒ‰é’®æŸ¥çœ‹æ‚£è€…çš„ä½“æ¸©è®°å½•</p>
                </div>
                
                <div class="patient-list" id="patientsList">
                    <p style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ‚£è€…è®°å½•</p>
                </div>
                
                <hr style="margin: 25px 0; border: none; border-top: 2px solid #eee;">
                
                <div class="section-title">ğŸ“ æ·»åŠ ä½“æ¸©è®°å½•</div>
                <div class="info-box">
                    <h3>âš ï¸ æç¤º</h3>
                    <p>è¯·å…ˆåŠ è½½æˆ–åˆ›å»ºæ‚£è€…åå†æ·»åŠ è®°å½•</p>
                </div>
                
                <div class="form-group">
                    <label>æ—¶é—´ *</label>
                    <input type="datetime-local" id="recordDateTime">
                </div>
                
                <div class="form-group">
                    <label>ä½“æ¸©(â„ƒ) *</label>
                    <input type="number" id="recordTemp" placeholder="36.5" step="0.1" min="35" max="42">
                </div>
                
                <div class="form-group">
                    <label>ç”¨è¯ä¿¡æ¯</label>
                    <textarea id="recordMedication" placeholder="å¦‚ï¼šæ³°è¯º1.5mlã€å¸ƒæ´›èŠ¬æ‚¬æ¶²5ml ç­‰" rows="2"></textarea>
                </div>
                
                <div class="btn-group">
                    <button class="btn-primary" onclick="addRecord()" id="addRecordBtn" disabled>â• æ·»åŠ è®°å½•</button>
                    <button class="btn-secondary" onclick="autoFillTime()">ğŸ• è‡ªåŠ¨å¡«å……æ—¶é—´</button>
                </div>
                
                <hr style="margin: 25px 0; border: none; border-top: 2px solid #eee;">
                
                <div class="section-title">ğŸ“‹ æ‰¹é‡å¯¼å…¥</div>
                <div class="info-box">
                    <h3>âš ï¸ é‡è¦è¯´æ˜</h3>
                    <p>âœ“ è¯·å…ˆåŠ è½½æˆ–åˆ›å»ºæ‚£è€…</p>
                    <p>âœ“ è¾“å…¥åŸºå‡†æ—¥æœŸ</p>
                    <p>âœ“ ç²˜è´´ä½“æ¸©æ•°æ®</p>
                </div>
                
                <div class="form-group">
                    <label>åŸºå‡†æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰*</label>
                    <input type="date" id="baseDate" placeholder="2025-11-01">
                </div>
                
                <div class="form-group">
                    <label>ç²˜è´´æ•°æ®</label>
                    <textarea id="batchData" placeholder="21ç‚¹01åˆ† 38.5åº¦ æ³°è¯º1.5ml&#10;22ç‚¹35åˆ† 38.9åº¦ æ³°è¯º1ml&#10;..." rows="10" style="font-family: monospace; font-size: 12px;"></textarea>
                </div>
                
                <div id="previewBox" style="display: none;">
                    <div class="section-title">ğŸ“Š é¢„è§ˆ</div>
                    <div class="sort-indicator">âœ… æ•°æ®å·²æŒ‰æ—¶é—´æ’åº</div>
                    <div class="preview-box" id="previewList"></div>
                </div>
                
                <div class="btn-group">
                    <button class="btn-success" onclick="previewBatch()" id="previewBtn" disabled>ğŸ‘ï¸ é¢„è§ˆæ•°æ®</button>
                    <button class="btn-success" onclick="batchImport()" id="importBtn" disabled>ğŸ“¥ ç¡®è®¤å¯¼å…¥</button>
                </div>
            </div>
            
            <!-- å³ä¾§å›¾è¡¨åŒº -->
            <div style="overflow-y: auto; max-height: calc(100vh - 250px);">
                <div class="section-title">ğŸ“Š æ•°æ®å±•ç¤º</div>
                
                <div id="alertBox"></div>
                
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('chart')">ğŸ“ˆ æ›²çº¿å›¾</button>
                    <button class="tab-btn" onclick="switchTab('table')">ğŸ“‹ æ•°æ®è¡¨</button>
                    <button class="tab-btn" onclick="switchTab('stats')">ğŸ“Š ç»Ÿè®¡</button>
                </div>
                
                <!-- æ›²çº¿å›¾ -->
                <div id="chart" class="tab-content active">
                    <div class="chart-wrapper" id="chartWrapper">
                        <canvas id="tempCanvas"></canvas>
                        <div class="tooltip" id="tooltip" style="display: none;">
                            <div class="tooltip-content">
                                <div class="tooltip-time" id="tooltipTime"></div>
                                <div class="tooltip-temp" id="tooltipTemp"></div>
                                <div class="tooltip-med" id="tooltipMed"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #51cf66;"></div>
                            <span>æ­£å¸¸ (36.5-37.5â„ƒ)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff922b;"></div>
                            <span>å‡é«˜ (37.6-38.9â„ƒ)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff6b6b;"></div>
                            <span>å‘çƒ­ (â‰¥39â„ƒ)</span>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®è¡¨ -->
                <div id="table" class="tab-content">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>ä½“æ¸©(â„ƒ)</th>
                                    <th>ç”¨è¯</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ç»Ÿè®¡ -->
                <div id="stats" class="tab-content">
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-label">è®°å½•æ•°é‡</div>
                            <div class="stat-value" id="statCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœ€é«˜ä½“æ¸©</div>
                            <div class="stat-value" id="statMax">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœ€ä½ä½“æ¸©</div>
                            <div class="stat-value" id="statMin">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å¹³å‡ä½“æ¸©</div>
                            <div class="stat-value" id="statAvg">--</div>
                        </div>
                    </div>
                    <div class="info-box">
                        <h3>è¯¦ç»†ä¿¡æ¯</h3>
                        <p>æ—¶é—´è·¨åº¦ï¼š<span id="statSpan">--</span></p>
                        <p>æ­£å¸¸ä½“æ¸©èŒƒå›´ï¼š36.5~37.5â„ƒ</p>
                        <p style="margin-top: 10px; color: #667eea; font-weight: bold;">
                            ç”¨è¯æƒ…å†µç»Ÿè®¡ï¼š<span id="medicationStats">--</span>
                        </p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-secondary" onclick="exportCSV()" id="exportCsvBtn" disabled>ğŸ’¾ å¯¼å‡ºCSV</button>
                    <button class="btn-secondary" onclick="exportJSON()" id="exportJsonBtn" disabled>ğŸ’¾ å¯¼å‡ºJSON</button>
                    <button class="btn-secondary" onclick="printPage()" id="printBtn" disabled>ğŸ–¨ï¸ æ‰“å°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ‚£è€…ä¿¡æ¯å¼¹çª— -->
    <div class="modal" id="editPatientModal">
        <div class="modal-content">
            <h2>âœï¸ ç¼–è¾‘æ‚£è€…ä¿¡æ¯</h2>
            
            <div class="form-group">
                <label>æ‚£è€…å§“å *</label>
                <input type="text" id="editPatientName" placeholder="è¯·è¾“å…¥æ‚£è€…å§“å">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>å¹´é¾„</label>
                    <input type="number" id="editPatientAge" placeholder="å²" min="0" max="120">
                </div>
                <div class="form-group">
                    <label>æ€§åˆ«</label>
                    <select id="editPatientGender">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn-primary" onclick="saveEditPatient()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                <button class="btn-secondary" onclick="closeEditPatientModal()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ä½“æ¸©è®°å½•å¼¹çª— -->
    <div class="modal" id="editRecordModal">
        <div class="modal-content">
            <h2>âœï¸ ç¼–è¾‘ä½“æ¸©è®°å½•</h2>
            
            <div class="form-group">
                <label>æ—¶é—´ *</label>
                <input type="datetime-local" id="editRecordDateTime">
            </div>
            
            <div class="form-group">
                <label>ä½“æ¸©(â„ƒ) *</label>
                <input type="number" id="editRecordTemp" placeholder="36.5" step="0.1" min="35" max="42">
            </div>
            
            <div class="form-group">
                <label>ç”¨è¯ä¿¡æ¯</label>
                <textarea id="editRecordMedication" placeholder="å¦‚ï¼šæ³°è¯º1.5mlã€å¸ƒæ´›èŠ¬æ‚¬æ¶²5ml ç­‰" rows="3"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn-primary" onclick="saveEditRecord()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                <button class="btn-danger" onclick="deleteEditRecord()">ğŸ—‘ï¸ åˆ é™¤è®°å½•</button>
                <button class="btn-secondary" onclick="closeEditRecordModal()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ============ å…¨å±€å˜é‡ ============
        let currentPatientId = null;
        let currentPatientOldName = null;
        let editingRecordTimestamp = null;
        let chartRecords = [];
        let chartCanvasWidth = 0;
        let chartCanvasHeight = 0;
        let chartPadding = { top: 30, right: 30, bottom: 60, left: 70 };
        let chartMinTemp = 36;
        let chartMaxTemp = 38;
        let batchPreviewData = [];

        // ============ æ•°æ®ç®¡ç† ============
        class Storage {
            static get(key, def = null) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : def;
                } catch {
                    return def;
                }
            }
            
            static set(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch {
                    alert('å­˜å‚¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™');
                    return false;
                }
            }
            
            static add(key, item) {
                const list = this.get(key, []);
                list.push(item);
                return this.set(key, list);
            }
            
            static remove(key, timestamp) {
                const list = this.get(key, []);
                const filtered = list.filter(item => item.timestamp !== timestamp);
                return this.set(key, filtered);
            }
            
            static clear(key) {
                localStorage.removeItem(key);
            }
        }

        // ============ æ‚£è€…ç®¡ç† ============
        function createNewPatient() {
            const name = document.getElementById('patientName').value.trim();
            const age = document.getElementById('patientAge').value;
            const gender = document.getElementById('patientGender').value;
            
            if (!name) {
                showAlert('è¯·è¾“å…¥æ‚£è€…å§“å', 'danger');
                return;
            }
            
            const patients = Storage.get('allPatients', {});
            if (patients[name]) {
                showAlert('æ‚£è€…å·²å­˜åœ¨ï¼è¯·ä¿®æ”¹å§“åæˆ–ç›´æ¥åŠ è½½è¯¥æ‚£è€…', 'warning');
                return;
            }
            
            const patientData = {
                name: name,
                age: age || '',
                gender: gender || '',
                createdAt: new Date().toLocaleString('zh-CN'),
                records: []
            };
            
            patients[name] = patientData;
            Storage.set('allPatients', patients);
            
            loadPatient(name);
            clearCurrentPatient();
            showAlert(`âœ… æ‚£è€… ${name} åˆ›å»ºæˆåŠŸï¼`, 'success');
        }

        function loadPatient(patientName) {
            const patients = Storage.get('allPatients', {});
            
            if (!patients[patientName]) {
                showAlert(`âŒ æ‚£è€… ${patientName} ä¸å­˜åœ¨`, 'danger');
                return;
            }
            
            const patient = patients[patientName];
            currentPatientId = patientName;
            currentPatientOldName = patientName;
            
            document.getElementById('patientName').value = patient.name;
            document.getElementById('patientAge').value = patient.age || '';
            document.getElementById('patientGender').value = patient.gender || '';
            
            showCurrentPatient(patient);
            
            document.getElementById('addRecordBtn').disabled = false;
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('importBtn').disabled = false;
            document.getElementById('exportCsvBtn').disabled = false;
            document.getElementById('exportJsonBtn').disabled = false;
            document.getElementById('printBtn').disabled = false;
            
            updateUI();
            showAlert(`âœ… å·²åŠ è½½æ‚£è€…ï¼š${patientName}`, 'info');
        }

        function showCurrentPatient(patient) {
            const display = document.getElementById('currentPatientDisplay');
            const nameEl = document.getElementById('currentPatientName');
            const infoEl = document.getElementById('currentPatientInfo');
            
            nameEl.textContent = `ğŸ‘¤ ${patient.name}`;
            infoEl.textContent = `å¹´é¾„ï¼š${patient.age || 'æœªå¡«'}  |  æ€§åˆ«ï¼š${patient.gender || 'æœªå¡«'}  |  è®°å½•æ•°ï¼š${(patient.records || []).length}`;
            display.style.display = 'block';
        }

        function clearCurrentPatient() {
            document.getElementById('patientName').value = '';
            document.getElementById('patientAge').value = '';
            document.getElementById('patientGender').value = '';
        }

        function editCurrentPatient() {
            if (!currentPatientId) {
                showAlert('è¯·å…ˆé€‰æ‹©æ‚£è€…', 'danger');
                return;
            }
            
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            
            document.getElementById('editPatientName').value = patient.name;
            document.getElementById('editPatientAge').value = patient.age || '';
            document.getElementById('editPatientGender').value = patient.gender || '';
            
            openEditPatientModal();
        }

        function openEditPatientModal() {
            document.getElementById('editPatientModal').classList.add('show');
        }

        function closeEditPatientModal() {
            document.getElementById('editPatientModal').classList.remove('show');
        }

        function saveEditPatient() {
            const newName = document.getElementById('editPatientName').value.trim();
            const newAge = document.getElementById('editPatientAge').value;
            const newGender = document.getElementById('editPatientGender').value;
            
            if (!newName) {
                showAlert('æ‚£è€…å§“åä¸èƒ½ä¸ºç©º', 'danger');
                return;
            }
            
            const patients = Storage.get('allPatients', {});
            
            if (newName !== currentPatientOldName && patients[newName]) {
                showAlert('è¯¥æ‚£è€…åç§°å·²å­˜åœ¨', 'danger');
                return;
            }
            
            const oldPatient = patients[currentPatientOldName];
            
            const updatedPatient = {
                name: newName,
                age: newAge,
                gender: newGender,
                createdAt: oldPatient.createdAt,
                records: oldPatient.records
            };
            
            if (newName !== currentPatientOldName) {
                delete patients[currentPatientOldName];
            }
            
            patients[newName] = updatedPatient;
            Storage.set('allPatients', patients);
            
            currentPatientId = newName;
            currentPatientOldName = newName;
            
            showCurrentPatient(updatedPatient);
            document.getElementById('patientName').value = newName;
            document.getElementById('patientAge').value = newAge;
            document.getElementById('patientGender').value = newGender;
            
            closeEditPatientModal();
            updatePatientsList();
            showAlert(`âœ… æ‚£è€…ä¿¡æ¯å·²æ›´æ–°`, 'success');
        }

        function deleteCurrentPatient() {
            if (!currentPatientId) {
                showAlert('è¯·å…ˆé€‰æ‹©æ‚£è€…', 'danger');
                return;
            }
            
            if (!confirm(`ç¡®å®šåˆ é™¤æ‚£è€… ${currentPatientId} åŠå…¶æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            const patients = Storage.get('allPatients', {});
            delete patients[currentPatientId];
            Storage.set('allPatients', patients);
            
            currentPatientId = null;
            currentPatientOldName = null;
            clearCurrentPatient();
            document.getElementById('currentPatientDisplay').style.display = 'none';
            
            document.getElementById('addRecordBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('importBtn').disabled = true;
            document.getElementById('exportCsvBtn').disabled = true;
            document.getElementById('exportJsonBtn').disabled = true;
            document.getElementById('printBtn').disabled = true;
            
            updatePatientsList();
            updateUI();
            showAlert(`âœ… æ‚£è€…å·²åˆ é™¤`, 'success');
        }

        function updatePatientsList() {
            const patients = Storage.get('allPatients', {});
            const list = document.getElementById('patientsList');
            
            if (Object.keys(patients).length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ‚£è€…è®°å½•</p>';
                return;
            }
            
            list.innerHTML = Object.entries(patients).map(([name, data]) => `
                <div class="patient-item">
                    <div class="patient-name">${name}</div>
                    <div class="patient-info">å¹´é¾„ï¼š${data.age || 'æœªå¡«'} | æ€§åˆ«ï¼š${data.gender || 'æœªå¡«'} | è®°å½•æ•°ï¼š${(data.records || []).length}</div>
                    <div class="patient-actions">
                        <button class="btn-sm btn-primary" onclick="loadPatient('${name}')">åŠ è½½</button>
                        <button class="btn-sm btn-danger" onclick="confirmDeletePatient('${name}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function confirmDeletePatient(name) {
            if (!confirm(`ç¡®å®šåˆ é™¤æ‚£è€… ${name} åŠå…¶æ‰€æœ‰è®°å½•å—ï¼Ÿ`)) {
                return;
            }
            
            const patients = Storage.get('allPatients', {});
            delete patients[name];
            Storage.set('allPatients', patients);
            
            if (currentPatientId === name) {
                currentPatientId = null;
                currentPatientOldName = null;
                clearCurrentPatient();
                document.getElementById('currentPatientDisplay').style.display = 'none';
                document.getElementById('addRecordBtn').disabled = true;
                document.getElementById('previewBtn').disabled = true;
                document.getElementById('importBtn').disabled = true;
                document.getElementById('exportCsvBtn').disabled = true;
                document.getElementById('exportJsonBtn').disabled = true;
                document.getElementById('printBtn').disabled = true;
                updateUI();
            }
            
            updatePatientsList();
            showAlert(`âœ… æ‚£è€… ${name} å·²åˆ é™¤`, 'success');
        }

        // ============ æ—¶é—´è§£æ ============
        function parseTime(timeStr) {
            let cleaned = timeStr.replace(/ç‚¹/g, ':').replace(/åˆ†/g, '').trim();
            const match = cleaned.match(/(\d{1,2}):?(\d{0,2})/);
            if (!match) return null;
            const hour = String(match[1]).padStart(2, '0');
            const minute = String(match[2] || '00').padStart(2, '0');
            return `${hour}:${minute}`;
        }

        function smartParseLine(line, baseDate) {
            const parts = line.trim().split(/\s+/).filter(p => p);
            if (parts.length < 2) return null;
            
            let dateStr = '';
            let timeStr = '';
            let tempStr = '';
            let medication = '';
            let idx = 0;
            
            if (/^\d{4}[\.-]\d{1,2}[\.-]\d{1,2}$/.test(parts[idx])) {
                dateStr = parts[idx].replace(/\./g, '-');
                idx++;
            } else {
                dateStr = baseDate;
            }
            
            if (parts[idx]) {
                const parsedTime = parseTime(parts[idx]);
                if (parsedTime) {
                    timeStr = parsedTime;
                    idx++;
                } else {
                    return null;
                }
            } else {
                return null;
            }
            
            if (parts[idx]) {
                tempStr = parts[idx].replace(/åº¦|â„ƒ|Â°C/g, '');
                let temp = parseFloat(tempStr);
                
                if (isNaN(temp) || temp < 35 || temp > 42) {
                    for (let i = idx; i < parts.length; i++) {
                        let t = parseFloat(parts[i]);
                        if (!isNaN(t) && t >= 35 && t <= 42) {
                            temp = t;
                            idx = i + 1;
                            break;
                        }
                    }
                    if (isNaN(temp) || temp < 35 || temp > 42) {
                        return null;
                    }
                } else {
                    idx++;
                }
            } else {
                return null;
            }
            
            if (idx < parts.length) {
                medication = parts.slice(idx).join(' ').replace(/[()ï¼ˆï¼‰]/g, '').trim();
            }
            
            if (!dateStr || !timeStr) return null;
            
            try {
                const fullDateTime = new Date(`${dateStr}T${timeStr}`);
                
                if (isNaN(fullDateTime.getTime())) {
                    return null;
                }
                
                const temp = parseFloat(tempStr);
                if (isNaN(temp) || temp < 35 || temp > 42) {
                    return null;
                }
                
                return {
                    datetime: fullDateTime.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    timestamp: fullDateTime.getTime(),
                    temp: temp,
                    medication: medication
                };
            } catch (e) {
                return null;
            }
        }

        // ============ è¾…åŠ©å‡½æ•° ============
        function showAlert(msg, type = 'success') {
            const box = document.getElementById('alertBox');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = msg;
            box.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        function switchTab(name) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
            });
            
            document.getElementById(name).classList.add('active');
            event.target.classList.add('active');
            
            if (name === 'chart') {
                setTimeout(() => {
                    const records = getSortedRecords();
                    drawChart(records);
                }, 100);
            }
        }

        function getNow() {
            const now = new Date();
            return now.toISOString().slice(0, 16);
        }

        function getTempClass(temp) {
            if (temp >= 39) return 'temp-fever';
            if (temp >= 37.6) return 'temp-elevated';
            return 'temp-normal';
        }

        function getSortedRecords() {
            if (!currentPatientId) return [];
            
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            if (!patient) return [];
            
            const records = patient.records || [];
            return records.sort((a, b) => a.timestamp - b.timestamp);
        }

        // ============ è®°å½•ç®¡ç† ============
        function autoFillTime() {
            document.getElementById('recordDateTime').value = getNow();
        }

        function addRecord() {
            if (!currentPatientId) {
                showAlert('è¯·å…ˆåŠ è½½æˆ–åˆ›å»ºæ‚£è€…', 'danger');
                return;
            }
            
            const datetime = document.getElementById('recordDateTime').value;
            const temp = parseFloat(document.getElementById('recordTemp').value);
            const medication = document.getElementById('recordMedication').value.trim();
            
            if (!datetime || !temp) {
                showAlert('è¯·å¡«å†™æ—¶é—´å’Œä½“æ¸©', 'danger');
                return;
            }
            
            const dt = new Date(datetime);
            const record = {
                datetime: dt.toLocaleString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                timestamp: dt.getTime(),
                temp,
                medication: medication || ''
            };
            
            const patients = Storage.get('allPatients', {});
            if (!patients[currentPatientId].records) {
                patients[currentPatientId].records = [];
            }
            patients[currentPatientId].records.push(record);
            Storage.set('allPatients', patients);
            
            document.getElementById('recordTemp').value = '';
            document.getElementById('recordMedication').value = '';
            
            showAlert('âœ… è®°å½•å·²æ·»åŠ ', 'success');
            updateUI();
            updatePatientsList();
        }

        function editRecord(timestamp) {
            if (!currentPatientId) return;
            
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            const record = patient.records.find(r => r.timestamp === timestamp);
            
            if (!record) return;
            
            editingRecordTimestamp = timestamp;
            
            // è½¬æ¢datetime-localæ ¼å¼
            const date = new Date(timestamp);
            const isoString = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            document.getElementById('editRecordDateTime').value = isoString;
            document.getElementById('editRecordTemp').value = record.temp;
            document.getElementById('editRecordMedication').value = record.medication;
            
            openEditRecordModal();
        }

        function openEditRecordModal() {
            document.getElementById('editRecordModal').classList.add('show');
        }

        function closeEditRecordModal() {
            document.getElementById('editRecordModal').classList.remove('show');
            editingRecordTimestamp = null;
        }

        function saveEditRecord() {
            if (!currentPatientId || editingRecordTimestamp === null) return;
            
            const newDateTime = document.getElementById('editRecordDateTime').value;
            const newTemp = parseFloat(document.getElementById('editRecordTemp').value);
            const newMedication = document.getElementById('editRecordMedication').value.trim();
            
            if (!newDateTime || !newTemp) {
                showAlert('è¯·å¡«å†™æ—¶é—´å’Œä½“æ¸©', 'danger');
                return;
            }
            
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            const recordIdx = patient.records.findIndex(r => r.timestamp === editingRecordTimestamp);
            
            if (recordIdx === -1) return;
            
            const dt = new Date(newDateTime);
            patient.records[recordIdx] = {
                datetime: dt.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                timestamp: dt.getTime(),
                temp: newTemp,
                medication: newMedication
            };
            
            Storage.set('allPatients', patients);
            
            closeEditRecordModal();
            showAlert('âœ… è®°å½•å·²æ›´æ–°', 'success');
            updateUI();
            updatePatientsList();
        }

        function deleteEditRecord() {
            if (!currentPatientId || editingRecordTimestamp === null) return;
            
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ')) return;
            
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            patient.records = patient.records.filter(r => r.timestamp !== editingRecordTimestamp);
            
            Storage.set('allPatients', patients);
            
            closeEditRecordModal();
            showAlert('âœ… è®°å½•å·²åˆ é™¤', 'success');
            updateUI();
            updatePatientsList();
        }

        function deleteRecord(timestamp) {
            if (!currentPatientId) return;
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ')) return;
            
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            patient.records = patient.records.filter(item => item.timestamp !== timestamp);
            Storage.set('allPatients', patients);
            
            showAlert('âœ… è®°å½•å·²åˆ é™¤', 'success');
            updateUI();
            updatePatientsList();
        }

        // ============ æ‰¹é‡å¯¼å…¥ ============
        function previewBatch() {
            if (!currentPatientId) {
                showAlert('è¯·å…ˆåŠ è½½æˆ–åˆ›å»ºæ‚£è€…', 'danger');
                return;
            }
            
            const baseDate = document.getElementById('baseDate').value;
            const text = document.getElementById('batchData').value.trim();
            
            if (!baseDate) {
                showAlert('è¯·è¾“å…¥åŸºå‡†æ—¥æœŸ', 'danger');
                return;
            }
            
            if (!text) {
                showAlert('è¯·ç²˜è´´æ•°æ®', 'danger');
                return;
            }
            
            const lines = text.split('\n').filter(l => l.trim());
            batchPreviewData = [];
            let successCount = 0;
            let errorCount = 0;
            
            lines.forEach((line, idx) => {
                const parsed = smartParseLine(line, baseDate);
                if (parsed) {
                    batchPreviewData.push(parsed);
                    successCount++;
                } else {
                    errorCount++;
                }
            });
            
            batchPreviewData.sort((a, b) => a.timestamp - b.timestamp);
            
            const previewList = document.getElementById('previewList');
            previewList.innerHTML = '';
            
            batchPreviewData.forEach(parsed => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `
                    <span>${parsed.datetime} | ${parsed.temp}â„ƒ | ${parsed.medication || 'æ— '}</span>
                    <span class="preview-status status-ok">âœ“</span>
                `;
                previewList.appendChild(item);
            });
            
            document.getElementById('previewBox').style.display = 'block';
            
            if (successCount > 0) {
                showAlert(`âœ… é¢„è§ˆå®Œæˆï¼šæˆåŠŸ ${successCount} æ¡${errorCount > 0 ? `ï¼Œå¤±è´¥ ${errorCount} æ¡` : ''}`);
            } else {
                showAlert(`âŒ æ²¡æœ‰æˆåŠŸè§£æä»»ä½•æ•°æ®`, 'danger');
            }
        }

        function batchImport() {
            if (!currentPatientId) {
                showAlert('è¯·å…ˆåŠ è½½æˆ–åˆ›å»ºæ‚£è€…', 'danger');
                return;
            }
            
            if (batchPreviewData.length === 0) {
                showAlert('è¯·å…ˆç‚¹å‡»é¢„è§ˆæ•°æ®', 'danger');
                return;
            }
            
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            if (!patient.records) {
                patient.records = [];
            }
            
            batchPreviewData.forEach(record => {
                patient.records.push(record);
            });
            
            Storage.set('allPatients', patients);
            
            showAlert(`âœ… æˆåŠŸå¯¼å…¥ ${batchPreviewData.length} æ¡è®°å½•`, 'success');
            document.getElementById('batchData').value = '';
            document.getElementById('previewBox').style.display = 'none';
            batchPreviewData = [];
            updateUI();
            updatePatientsList();
        }

        // ============ UIæ›´æ–° ============
        function updateUI() {
            const records = getSortedRecords();
            
            updateTable(records);
            drawChart(records);
            updateStats(records);
        }

        function updateTable(records) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = records.map(r => `
                <tr>
                    <td><strong>${r.datetime}</strong></td>
                    <td>
                        <strong class="${getTempClass(r.temp)}">${r.temp}â„ƒ</strong>
                    </td>
                    <td>
                        ${r.medication ? `<div class="medication-tag">${r.medication}</div>` : '<span style="color: #ccc;">--</span>'}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-info btn-sm" onclick="editRecord(${r.timestamp})">âœï¸</button>
                            <button class="btn-danger btn-sm" onclick="deleteRecord(${r.timestamp})">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(records) {
            if (records.length === 0) {
                document.getElementById('statCount').textContent = '0';
                document.getElementById('statMax').textContent = '--';
                document.getElementById('statMin').textContent = '--';
                document.getElementById('statAvg').textContent = '--';
                document.getElementById('statSpan').textContent = '--';
                document.getElementById('medicationStats').textContent = '--';
                return;
            }
            
            const temps = records.map(r => r.temp);
            const max = Math.max(...temps);
            const min = Math.min(...temps);
            const avg = (temps.reduce((a, b) => a + b) / temps.length).toFixed(1);
            
            document.getElementById('statCount').textContent = records.length;
            document.getElementById('statMax').textContent = max.toFixed(1);
            document.getElementById('statMin').textContent = min.toFixed(1);
            document.getElementById('statAvg').textContent = avg;
            
            if (records.length > 1) {
                const first = new Date(records[0].timestamp);
                const last = new Date(records[records.length - 1].timestamp);
                const hours = Math.floor((last - first) / (1000 * 60 * 60));
                const minutes = Math.floor(((last - first) % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById('statSpan').textContent = `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            }
            
            const medications = records.filter(r => r.medication).map(r => r.medication);
            
            if (medications.length > 0) {
                const medMap = {};
                medications.forEach(m => {
                    medMap[m] = (medMap[m] || 0) + 1;
                });
                const medStats = Object.entries(medMap)
                    .map(([med, count]) => `${med}(${count}æ¬¡)`)
                    .join(' | ');
                document.getElementById('medicationStats').textContent = medStats;
            } else {
                document.getElementById('medicationStats').textContent = 'æœªè®°å½•ç”¨è¯';
            }
        }

        // ============ ç»˜åˆ¶å›¾è¡¨ ============
        function drawChart(records) {
            const canvas = document.getElementById('tempCanvas');
            const wrapper = document.getElementById('chartWrapper');
            
            if (!canvas || records.length === 0) return;
            
            chartRecords = records;
            const ctx = canvas.getContext('2d');
            const w = wrapper.offsetWidth;
            const h = wrapper.offsetHeight;
            
            chartCanvasWidth = w;
            chartCanvasHeight = h;
            
            canvas.width = w;
            canvas.height = h;
            
            const temps = records.map(r => r.temp);
            chartMinTemp = Math.min(...temps, 36);
            chartMaxTemp = Math.max(...temps, 38);
            
            const range = chartMaxTemp - chartMinTemp;
            const padding = 0.5;
            chartMinTemp -= padding;
            chartMaxTemp += padding;
            const finalRange = chartMaxTemp - chartMinTemp;
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, w, h);
            
            // Yè½´
            const yAxisX = chartPadding.left;
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(yAxisX, chartPadding.top);
            ctx.lineTo(yAxisX, h - chartPadding.bottom);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(yAxisX, chartPadding.top);
            ctx.lineTo(yAxisX - 5, chartPadding.top + 10);
            ctx.lineTo(yAxisX + 5, chartPadding.top + 10);
            ctx.closePath();
            ctx.fillStyle = '#333';
            ctx.fill();
            
            ctx.font = 'bold 14px sans-serif';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'right';
            ctx.fillText('ä½“æ¸©(â„ƒ)', yAxisX - 10, 15);
            
            // Xè½´
            const xAxisY = h - chartPadding.bottom;
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(yAxisX, xAxisY);
            ctx.lineTo(w - chartPadding.right, xAxisY);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(w - chartPadding.right, xAxisY);
            ctx.lineTo(w - chartPadding.right - 10, xAxisY - 5);
            ctx.lineTo(w - chartPadding.right - 10, xAxisY + 5);
            ctx.closePath();
            ctx.fillStyle = '#333';
            ctx.fill();
            
            ctx.font = 'bold 14px sans-serif';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.fillText('æ—¶é—´', w - 15, h - 5);
            
            // Yè½´åˆ»åº¦
            ctx.font = '12px sans-serif';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= 6; i++) {
                const temp = chartMinTemp + (finalRange / 6) * i;
                const y = xAxisY - ((temp - chartMinTemp) / finalRange) * (xAxisY - chartPadding.top);
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(yAxisX - 5, y);
                ctx.lineTo(yAxisX + 2, y);
                ctx.stroke();
                
                ctx.fillStyle = '#333';
                ctx.fillText(temp.toFixed(1) + 'Â°', yAxisX - 8, y + 4);
                
                ctx.strokeStyle = '#ddd';
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(yAxisX + 5, y);
                ctx.lineTo(w - chartPadding.right, y);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Xè½´æ—¶é—´åˆ»åº¦
            ctx.font = '11px sans-serif';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            
            let timeStep = Math.ceil(records.length / 8);
            
            for (let i = 0; i < records.length; i += timeStep) {
                const x = yAxisX + (i / Math.max(records.length - 1, 1)) * (w - yAxisX - chartPadding.right);
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, xAxisY);
                ctx.lineTo(x, xAxisY + 5);
                ctx.stroke();
                
                const record = records[i];
                const timeMatch = record.datetime.match(/(\d{2}):(\d{2})/);
                if (timeMatch) {
                    ctx.fillStyle = '#333';
                    ctx.save();
                    ctx.translate(x, xAxisY + 10);
                    ctx.rotate(-Math.PI / 6);
                    ctx.fillText(`${timeMatch[1]}:${timeMatch[2]}`, 0, 0);
                    ctx.restore();
                }
            }
            
            // æ­£å¸¸èŒƒå›´
            const y36_5 = xAxisY - ((36.5 - chartMinTemp) / finalRange) * (xAxisY - chartPadding.top);
            const y37_5 = xAxisY - ((37.5 - chartMinTemp) / finalRange) * (xAxisY - chartPadding.top);
            ctx.fillStyle = 'rgba(81, 207, 102, 0.1)';
            ctx.fillRect(yAxisX + 5, y37_5, w - yAxisX - chartPadding.right - 5, y36_5 - y37_5);
            
            ctx.font = 'bold 12px sans-serif';
            ctx.fillStyle = 'rgba(81, 207, 102, 0.7)';
            ctx.textAlign = 'right';
            ctx.fillText('æ­£å¸¸èŒƒå›´', w - chartPadding.right - 10, (y36_5 + y37_5) / 2);
            
            // æ›²çº¿
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            records.forEach((r, i) => {
                const x = yAxisX + (i / Math.max(records.length - 1, 1)) * (w - yAxisX - chartPadding.right);
                const y = xAxisY - ((r.temp - chartMinTemp) / finalRange) * (xAxisY - chartPadding.top);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // æ•°æ®ç‚¹
            records.forEach((r, i) => {
                const x = yAxisX + (i / Math.max(records.length - 1, 1)) * (w - yAxisX - chartPadding.right);
                const y = xAxisY - ((r.temp - chartMinTemp) / finalRange) * (xAxisY - chartPadding.top);
                
                if (r.temp >= 39) ctx.fillStyle = '#ff6b6b';
                else if (r.temp >= 37.6) ctx.fillStyle = '#ff922b';
                else ctx.fillStyle = '#51cf66';
                
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.stroke();
            });
        }

        // ============ äº¤äº’å¼æç¤º ============
        function findClosestPoint(mouseX, mouseY) {
            if (chartRecords.length === 0) return null;
            
            const w = chartCanvasWidth;
            const h = chartCanvasHeight;
            const xAxisY = h - chartPadding.bottom;
            const yAxisX = chartPadding.left;
            
            const temps = chartRecords.map(r => r.temp);
            const minTemp = Math.min(...temps, 36) - 0.5;
            const maxTemp = Math.max(...temps, 38) + 0.5;
            const range = maxTemp - minTemp;
            
            let closestIdx = -1;
            let closestDist = Infinity;
            
            chartRecords.forEach((r, i) => {
                const x = yAxisX + (i / Math.max(chartRecords.length - 1, 1)) * (w - yAxisX - chartPadding.right);
                const y = xAxisY - ((r.temp - minTemp) / range) * (xAxisY - chartPadding.top);
                
                const dist = Math.hypot(mouseX - x, mouseY - y);
                if (dist < closestDist) {
                    closestDist = dist;
                    closestIdx = i;
                }
            });
            
            if (closestDist < 30) return closestIdx;
            return null;
        }

        const canvas = document.getElementById('tempCanvas');
        canvas.addEventListener('mousemove', (event) => {
            const wrapper = document.getElementById('chartWrapper');
            const rect = canvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;
            const tooltip = document.getElementById('tooltip');
            
            const idx = findClosestPoint(mouseX, mouseY);
            
            if (idx !== null && chartRecords[idx]) {
                const record = chartRecords[idx];
                document.getElementById('tooltipTime').textContent = `ğŸ“… ${record.datetime}`;
                document.getElementById('tooltipTemp').textContent = `ğŸŒ¡ï¸ ${record.temp}â„ƒ`;
                document.getElementById('tooltipMed').textContent = record.medication ? `ğŸ’Š ${record.medication}` : '';
                
                let x = event.clientX - rect.left;
                let y = event.clientY - rect.top - 70;
                
                if (x + 150 > rect.width) x = rect.width - 150;
                if (y < 0) y = event.clientY - rect.top + 20;
                
                tooltip.style.display = 'block';
                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            } else {
                tooltip.style.display = 'none';
            }
        });

        canvas.addEventListener('mouseleave', () => {
            document.getElementById('tooltip').style.display = 'none';
        });

        // ============ å¯¼å‡º ============
        function exportCSV() {
            if (!currentPatientId) {
                showAlert('è¯·å…ˆåŠ è½½æ‚£è€…', 'danger');
                return;
            }
            
            const records = getSortedRecords();
            if (records.length === 0) {
                showAlert('æ²¡æœ‰æ•°æ®', 'danger');
                return;
            }
            
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            
            let csv = 'æ‚£è€…å§“å,å¹´é¾„,æ€§åˆ«\n';
            csv += `${patient.name},${patient.age || ''},${patient.gender || ''}\n\n`;
            csv += 'æ—¶é—´,ä½“æ¸©(â„ƒ),ç”¨è¯\n';
            
            records.forEach(r => {
                csv += `${r.datetime},${r.temp},"${r.medication}"\n`;
            });
            
            downloadFile(csv, `${patient.name}_temperature_record.csv`);
            showAlert('âœ… CSVå·²å¯¼å‡º', 'success');
        }

        function exportJSON() {
            if (!currentPatientId) {
                showAlert('è¯·å…ˆåŠ è½½æ‚£è€…', 'danger');
                return;
            }
            
            const records = getSortedRecords();
            const patients = Storage.get('allPatients', {});
            const patient = patients[currentPatientId];
            
            const data = {
                patient: {
                    name: patient.name,
                    age: patient.age,
                    gender: patient.gender,
                    createdAt: patient.createdAt
                },
                records,
                exportTime: new Date().toLocaleString('zh-CN'),
                statistics: {
                    count: records.length,
                    maxTemp: records.length > 0 ? Math.max(...records.map(r => r.temp)) : null,
                    minTemp: records.length > 0 ? Math.min(...records.map(r => r.temp)) : null,
                    avgTemp: records.length > 0 ? (records.reduce((a, b) => a + b.temp, 0) / records.length).toFixed(1) : null
                }
            };
            
            downloadFile(JSON.stringify(data, null, 2), `${patient.name}_temperature_record.json`);
            showAlert('âœ… JSONå·²å¯¼å‡º', 'success');
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printPage() {
            window.print();
        }

        // ============ åˆå§‹åŒ– ============
        window.addEventListener('load', () => {
            document.getElementById('recordDateTime').value = getNow();
            const today = new Date();
            document.getElementById('baseDate').value = today.toISOString().split('T')[0];
            
            window.addEventListener('click', (e) => {
                const modal1 = document.getElementById('editPatientModal');
                const modal2 = document.getElementById('editRecordModal');
                if (e.target === modal1) closeEditPatientModal();
                if (e.target === modal2) closeEditRecordModal();
            });
            
            updatePatientsList();
            updateUI();
        });

        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
        window.loadPatient = loadPatient;
        window.confirmDeletePatient = confirmDeletePatient;
    </script>
</body>
</html>
